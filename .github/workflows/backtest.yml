name: Backtest

on:
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Branch or tag to run from (defaults to triggering ref)"
        required: false

jobs:
  backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_ref || github.ref }}

      - name: Compute time windows
        id: times
        run: |
          TRAIN_END_ISO=$(date -u -d '90 minutes ago' --iso-8601=seconds)
          # backtest window: last 14 full days ending today-minus-60m (date-based)
          BACKTEST_END=$(date -u -d '60 minutes ago' +%Y-%m-%d)
          BACKTEST_START=$(date -u -d '14 days ago' +%Y-%m-%d)
          DATE_PART=$(date -u +%Y-%m-%dT%H%M%SZ)
          echo "TRAIN_END_ISO=$TRAIN_END_ISO" >> $GITHUB_ENV
          echo "BACKTEST_START=$BACKTEST_START" >> $GITHUB_ENV
          echo "BACKTEST_END=$BACKTEST_END" >> $GITHUB_ENV
          echo "DATE_PART=$DATE_PART" >> $GITHUB_ENV
          echo "train_end_iso=$TRAIN_END_ISO"
          echo "backtest_start=$BACKTEST_START"
          echo "backtest_end=$BACKTEST_END"
          echo "date_part=$DATE_PART"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r ml/requirements.txt

      - name: Train with cutoff
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          TRAIN_END_ISO: ${{ env.TRAIN_END_ISO }}
        run: |
          python ml/train_model.py

      - name: Backtest with latest artifacts
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          python ml/backtest_v2.py \
            --start-date "${{ env.BACKTEST_START }}" \
            --end-date "${{ env.BACKTEST_END }}" \
            --meta-key models/quantile/latest_meta.json \
            --train-window-days 4 \
            --test-window-days 1 \
            --embargo-minutes 60 \
            --prob-thresholds "0.61,0.753" \
            --core-low-price-thresholds "0.61,0.753" \
            --low-regime-midprice-prob-thresholds "0.75" \
            --slippage-multipliers "1.0" \
            --upload-prefix analysis/backtest \
            --upload-date-part "${{ env.DATE_PART }}"

      - name: Upload backtest results
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: |
            ml/backtest_v2_trades.csv
            ml/backtest_v2_folds.csv
            ml/backtest_v2_summary.csv
            ml/backtest_v2_factor_grid.csv
