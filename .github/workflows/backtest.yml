name: Backtest

on:
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Branch or tag to run from (defaults to triggering ref)"
        required: false

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_ref || github.ref }}

      - name: Compute time windows
        id: times
        run: |
          TRAIN_END_ISO=$(date -u -d '90 minutes ago' --iso-8601=seconds)
          # backtest window: last 14 full days ending today-minus-60m (date-based)
          BACKTEST_END=$(date -u -d '60 minutes ago' +%Y-%m-%d)
          BACKTEST_START=$(date -u -d '14 days ago' +%Y-%m-%d)
          echo "TRAIN_END_ISO=$TRAIN_END_ISO" >> $GITHUB_ENV
          echo "BACKTEST_START=$BACKTEST_START" >> $GITHUB_ENV
          echo "BACKTEST_END=$BACKTEST_END" >> $GITHUB_ENV
          echo "train_end_iso=$TRAIN_END_ISO"
          echo "backtest_start=$BACKTEST_START"
          echo "backtest_end=$BACKTEST_END"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r ml/requirements.txt

      - name: Train with cutoff
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          TRAIN_END_ISO: ${{ env.TRAIN_END_ISO }}
        run: |
          python ml/train_model.py

      - name: Backtest with latest artifacts
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          python ml/backtest.py \
            --start-date "${{ env.BACKTEST_START }}" \
            --end-date "${{ env.BACKTEST_END }}"

      - name: Upload backtest results
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: backtest_results.csv

      - name: Push backtest results to R2
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          pip install awscli
          aws configure set default.s3.addressing_style virtual
          aws configure set default.s3.signature_version s3v4
          aws configure set default.region auto
          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_EC2_METADATA_DISABLED=true
          PREFIX="analysis/backtest"
          DATE_PART=$(date -u +%Y-%m-%dT%H%M%SZ)
          KEY="$PREFIX/backtest_results_${DATE_PART}.csv"
          aws s3 cp backtest_results.csv "s3://$R2_BUCKET/$KEY" --endpoint-url "$R2_ENDPOINT"
          echo "Pushed backtest results to s3://$R2_BUCKET/$KEY"
